name: Deploy Backend to EC2

on:
  push:
    branches: [ main ]
    paths: [ 'server/**' ]
  workflow_dispatch:

concurrency:
  group: deploy-backend
  cancel-in-progress: true

permissions:
  contents: read

env:
  SERVICE_DIR: /home/ec2-user/DARAPO/server

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # .env íŒŒì¼ ë°±ì—…
      - name: Backup .env file
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            if [ -f /home/ec2-user/DARAPO/server/.env ]; then
              cp /home/ec2-user/DARAPO/server/.env /tmp/.env.backup
              echo "âœ… .env ë°±ì—… ì™„ë£Œ"
            fi

      # server í´ë”ë§Œ ë™ê¸°í™”
      - name: Sync server files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "server/"
          target: "/home/ec2-user/DARAPO/"
          overwrite: true

      # ë¹Œë“œ ë° ì¬ì‹œì‘
      - name: Build and restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            
            cd /home/ec2-user/DARAPO/server
            
            # nvm ì´ˆê¸°í™” (nvm ì‚¬ìš© ì‹œ)
            if [ -f ~/.nvm/nvm.sh ]; then
              source ~/.nvm/nvm.sh
              nvm use default || nvm use node
            fi
            
            # .env íŒŒì¼ ë³µì›
            if [ -f /tmp/.env.backup ]; then
              cp /tmp/.env.backup .env
              rm /tmp/.env.backup
              echo "âœ… .env ë³µì› ì™„ë£Œ"
            fi
            
            # ì˜ì¡´ì„± ì„¤ì¹˜ (ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨)
            echo "ğŸ“¦ Installing dependencies..."
            npm ci || { echo "âŒ npm ci failed"; exit 1; }
            
            # ë¹Œë“œ (npm ci ì„±ê³µ í›„)
            echo "ğŸ”¨ Building application..."
            npm run build || { echo "âŒ Build failed"; exit 1; }
            
            # PM2 ì¬ì‹œì‘ (ê²½ë¡œ ë³´ì¥)
            echo "ğŸ”„ Reloading PM2..."
            npx pm2 reload ecosystem.config.js || pm2 reload ecosystem.config.js || { echo "âŒ PM2 reload failed"; exit 1; }
            
            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ” Health check..."
            sleep 10
            if curl -f http://localhost:3000/api > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
            else
              echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              npx pm2 logs --lines 10 || pm2 logs --lines 10
              exit 1
            fi